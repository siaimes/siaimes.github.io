<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>BaseArnl: centralServerExample.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BaseArnl
   &#160;<span id="projectnumber">1.9.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('centralServerExample_8cpp-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">centralServerExample.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>Example of a central server which allows clients to communicate with multiple robot servers through one connection, and for the multiple robot servers to share information. This is a simple "central robot server": it uses ArCentralManager for ArNetworking to multiplex several ArNetworking connections through one ArNetworking server. Servers (e.g. guiServer) running on several robots can then be invoked with the "-centralServer" argument (and others), and they will accept client connections through this central server. Clients supporting multiple robots, such as recent version of MobileEyes, can connect to the central server.</p>
<p>The central server can also hold common configuration options and/or a common map.</p>
<p>You use this example program as-is, or add to it to implement multi-robot coordination etc.</p>
<p>Note, this server uses the default server port, 7272. Any other servers running on the same computer will need to use a different port (e.g. use the -serverPort argument).</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;Aria.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArNetworking.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Arnl.h&quot;</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Called whenever a new robot server connects and a forwarder is created for</span></div>
<div class="line"><span class="comment">// it. (Defined after main() below.)</span></div>
<div class="line"><span class="keywordtype">void</span> robotForwarderAdded(<a name="_a0"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArCentralForwarder.html">ArCentralForwarder</a> *forwarder);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  <a name="a1"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#a5361d8684b2cd73c089efecd3d090d20">Aria::init</a>();</div>
<div class="line">  <a name="_a2"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArArgumentParser.html">ArArgumentParser</a> parser(&amp;argc, argv);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* This server accepts connections from the several robot servers. It&#39;s port</span></div>
<div class="line"><span class="comment">   * number is set using the -&lt;name&gt;ServerPort argument, where &lt;name&gt; is given</span></div>
<div class="line"><span class="comment">   * here as &quot;robot&quot;. (A default of 5000 set below, this number should always</span></div>
<div class="line"><span class="comment">   * be used). */</span></div>
<div class="line"></div>
<div class="line">  <a name="_a3"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArServerSimpleOpener.html">ArServerSimpleOpener</a> robotServersOpener(&amp;parser, <span class="stringliteral">&quot;robot&quot;</span>);</div>
<div class="line">  <a name="_a4"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArServerBase.html">ArServerBase</a> robotServer(<span class="keyword">true</span>, <span class="stringliteral">&quot;RobotServer&quot;</span>, <span class="keyword">false</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Set robotServerPort to 5000, to avoid conflicting with the</span></div>
<div class="line">  <span class="comment">// server port used for clients, which will use the normal</span></div>
<div class="line">  <span class="comment">// default of 7272.</span></div>
<div class="line">  parser.addDefaultArgument(<span class="stringliteral">&quot;-robotServerPort 5000&quot;</span>, 1);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/* This server accepts connections from clients: */</span></div>
<div class="line"></div>
<div class="line">  <a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArServerSimpleOpener.html">ArServerSimpleOpener</a> clientOpener(&amp;parser, <span class="stringliteral">&quot;client&quot;</span>);</div>
<div class="line">  <a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArServerBase.html">ArServerBase</a> clientServer(<span class="keyword">true</span>, <span class="stringliteral">&quot;ClientServer&quot;</span>, <span class="keyword">false</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Load other defaults from files and environment</span></div>
<div class="line">  parser.loadDefaultArguments(1);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Parse arguments */</span></div>
<div class="line">  <span class="keywordflow">if</span>(!<a name="a5"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#ab59150570b5e1a426045e45ee43929c3">Aria::parseArgs</a>() || !parser.checkHelpAndWarnUnparsed())</div>
<div class="line">  {</div>
<div class="line">    <a name="a6"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#a75aefec78ffa23cfab6bdb46754dd991">Aria::logOptions</a>();</div>
<div class="line">    <a name="a7"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#ac29a02c2e6637417bd7a5a5f1513da74">Aria::exit</a>(0);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Open servers */</span></div>
<div class="line"></div>
<div class="line">  <a name="a8"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#adb017560cb244d90ed80acc56586a451">ArLog::log</a>(<a name="a9"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#ac8cc0fb3aa323ab2a1c21340fdd1dce3a7040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">&quot;Opening connection point for robot servers...&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (!robotServersOpener.open(&amp;robotServer, <span class="stringliteral">&quot;&quot;</span>, 120) || !robotServersOpener.checkAndLog())</div>
<div class="line">  {</div>
<div class="line">    <a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#adb017560cb244d90ed80acc56586a451">ArLog::log</a>(<a name="a10"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#ac8cc0fb3aa323ab2a1c21340fdd1dce3a012daf6573594f91242f8dd7c02eb74b">ArLog::Terse</a>, <span class="stringliteral">&quot;Could not open connection point (server) for robot servers&quot;</span>);</div>
<div class="line">    <a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#ac29a02c2e6637417bd7a5a5f1513da74">Aria::exit</a>(1);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#adb017560cb244d90ed80acc56586a451">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#ac8cc0fb3aa323ab2a1c21340fdd1dce3a7040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">&quot;Opening server for clients...&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (!clientOpener.open(&amp;clientServer, <span class="stringliteral">&quot;&quot;</span>, 120) || !clientOpener.checkAndLog())</div>
<div class="line">  {</div>
<div class="line">    <a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#adb017560cb244d90ed80acc56586a451">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#ac8cc0fb3aa323ab2a1c21340fdd1dce3a012daf6573594f91242f8dd7c02eb74b">ArLog::Terse</a>, <span class="stringliteral">&quot;Could not open server for clients&quot;</span>);</div>
<div class="line">    <a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#ac29a02c2e6637417bd7a5a5f1513da74">Aria::exit</a>(1);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/* This keeps track of the several robot servers. When a robot server</span></div>
<div class="line"><span class="comment">   * connects to the robotsServer connection point, an ArCentralForwarder</span></div>
<div class="line"><span class="comment">   * object is created for that robot server. When a client</span></div>
<div class="line"><span class="comment">   * connects to the clientServer, it is informed of ports it can</span></div>
<div class="line"><span class="comment">   * connect to to reach the robot servers via the forwarder objects.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  ArCentralManager centralManager(&amp;robotServer, &amp;clientServer);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* ArCentralManager also can invoke callbacks whenever a new robot server</span></div>
<div class="line"><span class="comment">   * connects and its ArCentralForwarder object is created. Commands can</span></div>
<div class="line"><span class="comment">   * be sent to the robots via these forwarders.</span></div>
<div class="line"><span class="comment">   * Here is an example:</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="_a11"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArGlobalFunctor1.html">ArGlobalFunctor1&lt;ArCentralForwarder*&gt;</a> exampleNewForwarderCB(&amp;robotForwarderAdded);</div>
<div class="line">  centralManager.addForwarderAddedCallback(&amp;exampleNewForwarderCB);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Clients can send config requests to/from the robot servers, but</span></div>
<div class="line"><span class="comment">   * this allows you to also modify this central server&#39;s global configuration</span></div>
<div class="line"><span class="comment">   * (if you or any Aria class adds options to the global Aria ArConfig</span></div>
<div class="line"><span class="comment">   * object).</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="_a12"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArServerHandlerConfig.html">ArServerHandlerConfig</a> handlerConfig(&amp;clientServer, <a name="a13"></a><a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#aa7b554e24d02c753180556a2791e83f2">Aria::getConfig</a>());</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* monitor communication between the server and client. */</span></div>
<div class="line">  <a name="_a14"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArServerHandlerCommMonitor.html">ArServerHandlerCommMonitor</a> commMonitor(&amp;clientServer);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* custom/simple commands, but give them different names than the robot</span></div>
<div class="line"><span class="comment">   * servers&#39; simple commands:</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <a name="_a15"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArServerHandlerCommands.html">ArServerHandlerCommands</a> commands(&amp;clientServer);</div>
<div class="line">  commands.setPrefix(<span class="stringliteral">&quot;CentralServer&quot;</span>);</div>
<div class="line">  </div>
<div class="line">  ArServerSimpleServerCommands *serverCommands = NULL;</div>
<div class="line">  serverCommands = <span class="keyword">new</span> ArServerSimpleServerCommands(&amp;commands, &amp;clientServer);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Drawings for the client, used to draw information about multiple robots. */</span></div>
<div class="line">  <a name="_a16"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArServerInfoDrawings.html">ArServerInfoDrawings</a> drawings(&amp;clientServer);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Keep track of each robot, and send positions to other robots to use, and</span></div>
<div class="line"><span class="comment">   * drawings to clients showing points on the robots */</span></div>
<div class="line">  <a name="_a17"></a><a class="code" href="classArCentralMultiRobot.html" title="Class that gathers information from multiple robots and helps them avoid each other.">ArCentralMultiRobot</a> *centralMultiRobot = NULL;</div>
<div class="line">  centralMultiRobot = <span class="keyword">new</span> <a class="code" href="classArCentralMultiRobot.html" title="Class that gathers information from multiple robots and helps them avoid each other.">ArCentralMultiRobot</a>(&amp;centralManager, <a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#aa7b554e24d02c753180556a2791e83f2">Aria::getConfig</a>(), &amp;drawings);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Load a config file if given */</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment">  char errorBuffer[1024];</span></div>
<div class="line"><span class="comment">  if (!Aria::getConfig()-&gt;parseFile(parser.getArg(1), true, false, </span></div>
<div class="line"><span class="comment">                    errorBuffer, sizeof(errorBuffer)))</span></div>
<div class="line"><span class="comment">  {</span></div>
<div class="line"><span class="comment">    ArLog::log(ArLog::Terse, &quot;### Warning: Error loading configuration file \&quot;%s\&quot;: %s&quot;, argv[1], errorBuffer);</span></div>
<div class="line"><span class="comment">  }</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  // write it back in case new items need to be added:</span></div>
<div class="line"><span class="comment">  Aria::getConfig()-&gt;writeFile(Aria::getConfig()-&gt;getFileName());</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Run servers */</span></div>
<div class="line">  clientServer.runAsync();</div>
<div class="line">  robotServer.run();</div>
<div class="line">  <a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classAria.html#ac29a02c2e6637417bd7a5a5f1513da74">Aria::exit</a>(0);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Called whenever a new robot server connects and a forwarder is created for</span></div>
<div class="line"><span class="comment">// it.</span></div>
<div class="line"><span class="keywordtype">void</span> robotForwarderAdded(<a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArCentralForwarder.html">ArCentralForwarder</a> *forwarder)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Note that when a robot server connects to this central server, the central</span></div>
<div class="line">  <span class="comment">// server takes on the &quot;client&quot; role with respect to that server. So to send</span></div>
<div class="line">  <span class="comment">// requests or get information from a robot server, use the forwarder&#39;s</span></div>
<div class="line">  <span class="comment">// &quot;client&quot; object. (The forwarder&#39;s &quot;server&quot; object is the local port that </span></div>
<div class="line">  <span class="comment">// clients such as MobileEyes connect to.)</span></div>
<div class="line">  <a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#adb017560cb244d90ed80acc56586a451">ArLog::log</a>(<a class="codeRef" doxygen="Aria.tag:../Aria-Reference//" href="../Aria-Reference/classArLog.html#ac8cc0fb3aa323ab2a1c21340fdd1dce3a7040faf60eeb155eaa85d439b1066ca1">ArLog::Normal</a>, <span class="stringliteral">&quot;centralServerExample: New forwarder added for robot server named \&quot;%s\&quot; at host %s.&quot;</span>, forwarder-&gt;<a name="a18"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArCentralForwarder.html#aed239c95ac743783c6441096bff04826">getRobotName</a>(), forwarder-&gt;<a name="a19"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArCentralForwarder.html#a3020ab108707354561be1608f28a45f6">getClient</a>()-&gt;<a name="a20"></a><a class="codeRef" doxygen="ArNetworking.tag:../ArNetworking-Reference//" href="../ArNetworking-Reference/classArClientBase.html#a256422e22f97289927d8c8728d02a777">getHost</a>());</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Nov 15 2017 13:30:19 for BaseArnl by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1 </li>
  </ul>
</div>
</body>
</html>
