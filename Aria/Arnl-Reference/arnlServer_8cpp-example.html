<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>ARNL: arnlServer.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ARNL
   &#160;<span id="projectnumber">1.9.3</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('arnlServer_8cpp-example.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">arnlServer.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<p>example of almost all ARNL features</p>
<div class="fragment"><div class="line"></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;Aria.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArNetworking.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Arnl.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArPathPlanningInterface.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArLocalizationTask.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArDocking.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArSystemStatus.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArServerAdvertiser.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArServerModeJogPosition.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ArSimUtil.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> logOptions(<span class="keyword">const</span> <span class="keywordtype">char</span> *progname)</div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Usage: %s [options]\n&quot;</span>, progname);</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;[options] are any program options listed below, or any ARNL configuration&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;parameters as -name &lt;value&gt;, see params/arnl.p for list.&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;For example, -map &lt;map file&gt;.&quot;</span>);</div>
<div class="line">  Aria::logOptions();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> gyroErrored = <span class="keyword">false</span>;</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span>* getGyroStatusString(ArRobot* robot)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(!robot || !robot-&gt;getOrigRobotConfig() || robot-&gt;getOrigRobotConfig()-&gt;getGyroType() &lt; 2) <span class="keywordflow">return</span> <span class="stringliteral">&quot;N/A&quot;</span>;</div>
<div class="line">  <span class="keywordflow">if</span>(robot-&gt;getFaultFlags() &amp; ArUtil::BIT4)</div>
<div class="line">  {</div>
<div class="line">    gyroErrored = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;ERROR/OFF&quot;</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span>(gyroErrored)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="stringliteral">&quot;OK but error before&quot;</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">return</span> <span class="stringliteral">&quot;OK&quot;</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function is called from the ArRobot task thread on every robot update,</span></div>
<div class="line"><span class="comment">// which is every 100ms.  You can check timers here and do any non-blocking</span></div>
<div class="line"><span class="comment">// monitoring of I/O.  Any long-blocking operations must not be done in this</span></div>
<div class="line"><span class="comment">// callback however, or it will impact the ArRobot task thread and</span></div>
<div class="line"><span class="comment">// communications with the robot (use ArASyncTask to run a new thread instead.)</span></div>
<div class="line"><span class="keywordtype">void</span> robotTaskExample(ArRobot* robot)</div>
<div class="line">{</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function is called whenever a new goal is reached. It will be attached </span></div>
<div class="line"><span class="comment">// to the path planning task below in main() via ArPathPlanningTask::addGoalDoneCB()</span></div>
<div class="line"><span class="keywordtype">void</span> goalDone(ArPose goalPos) <span class="comment">//, ArPathPlanningTask *pathTask)</span></div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;ARNL server example: goal reached&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function is called if pathplanning fails. It will be attached </span></div>
<div class="line"><span class="comment">// to the path planning task below in main() via</span></div>
<div class="line"><span class="comment">// ArPathPlanningTask::addGoalFailedCB()</span></div>
<div class="line"><span class="keywordtype">void</span> goalFailed(ArPose goalPos) <span class="comment">//, ArPathPlanningTask *pathTask)</span></div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;ARNL server example: goal failed&quot;</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// This function is called if localization fails. It will be attached </span></div>
<div class="line"><span class="comment">// to the localization task below in main() via</span></div>
<div class="line"><span class="comment">// ArLocalizationTask::setFailedCallback()</span></div>
<div class="line"><span class="keywordtype">void</span> locFailed(<span class="keywordtype">int</span> n) <span class="comment">//, ArLocalizationTask* locTask)</span></div>
<div class="line">{</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;ARNL server example: localization failed&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// This function is called whenever the path planning task changes its state</span></div>
<div class="line"><span class="comment">// (for example, from idle to planning a path, to following a planned path). It will be attached </span></div>
<div class="line"><span class="comment">// to the path planning task below in main() via</span></div>
<div class="line"><span class="comment">// ArPathPlanningTask::addStateChangeCB()</span></div>
<div class="line"><span class="comment">//ArPathPlanningInterface *pathPlanningTask = NULL;</span></div>
<div class="line"><span class="keywordtype">void</span> pathPlanStateChanged(<a name="_a0"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html">ArPathPlanningTask</a> *pathPlanningTask)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">char</span> s[256];</div>
<div class="line">  pathPlanningTask-&gt;<a name="a1"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html#ab7e75be74d6295850fdb8b20551883c7">getFailureString</a>(s, 256);</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;ARNL server example: Path planning state: %s&quot;</span>, s);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// This class sends a warning message (popup) to a client if the robot&#39;s motors</span></div>
<div class="line"><span class="comment">// become disabled, with the option to re-enable them. This is neccesary on some</span></div>
<div class="line"><span class="comment">// robots (e.g. Pioneer LX) for the user to re-enable motors after e-stop.</span></div>
<div class="line"><span class="comment">// This class also changes the state of the Pioneer LX wheel lights based on </span></div>
<div class="line"><span class="comment">// e-stop and motor power conditions. (You can customize what the wheel lights</span></div>
<div class="line"><span class="comment">// do by modifying this or sending similar commands based on other conditions</span></div>
<div class="line"><span class="comment">// in your software.)</span></div>
<div class="line"><span class="keyword">class </span>RobotMonitor</div>
<div class="line">{</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  ArRobot *robot;</div>
<div class="line">  ArServerHandlerPopup *popupServer;</div>
<div class="line">  ArTypes::Byte4 motorsDisabledPopupID;</div>
<div class="line">  ArServerHandlerPopupInfo motorsDisabledPopupInfo;</div>
<div class="line">  ArFunctor2C&lt;RobotMonitor, ArTypes::Byte4, int&gt; handleMotorsDisabledPopupResponseCB;</div>
<div class="line">  ArFunctorC&lt;RobotMonitor&gt; robotMonitorCB;</div>
<div class="line">  ArTypes::Byte4 logDiskSpacePopupID;</div>
<div class="line">  ArServerHandlerPopupInfo logDiskSpacePopupInfo;</div>
<div class="line">  ArTypes::Byte4 datalogDiskSpacePopupID;</div>
<div class="line">  ArServerHandlerPopupInfo datalogDiskSpacePopupInfo;</div>
<div class="line">  ArDataLogger *datalog;</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  RobotMonitor(ArRobot *r, ArServerHandlerPopup *ps, ArDataLogger *dl = NULL) :</div>
<div class="line">    robot(r),</div>
<div class="line">    popupServer(ps),</div>
<div class="line">    motorsDisabledPopupID(0),</div>
<div class="line">    motorsDisabledPopupInfo( <span class="stringliteral">&quot;motorsDisabledPopup&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;Robot Motors Are Disabled&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;The robot&#39;s motors are disabled&quot;</span>, </div>
<div class="line">      ArServerHandlerPopup::WARNING,</div>
<div class="line">      1,  <span class="comment">// default button ID</span></div>
<div class="line">      0,  <span class="comment">// escape button ID</span></div>
<div class="line">      -1, <span class="comment">// timeout</span></div>
<div class="line">      NULL, <span class="comment">// timeout message</span></div>
<div class="line">      <span class="stringliteral">&quot;Enable Motors&quot;</span>, <span class="stringliteral">&quot;Enabling Motors...&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;Ignore&quot;</span>, <span class="stringliteral">&quot;Ignore&quot;</span></div>
<div class="line">    ),</div>
<div class="line">    handleMotorsDisabledPopupResponseCB(this, &amp;RobotMonitor::handleMotorsDisabledResponse),</div>
<div class="line">    robotMonitorCB(this, &amp;RobotMonitor::robotMonitorTask),</div>
<div class="line">    logDiskSpacePopupID(0),</div>
<div class="line">    logDiskSpacePopupInfo( <span class="stringliteral">&quot;logDiskSpacePopup&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;Low Disk Space Warning&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;The robot disk filesystem containing the log file has less than 400 MB free space remaining.&quot;</span>,</div>
<div class="line">      ArServerHandlerPopup::WARNING,</div>
<div class="line">      1, 1, -1, NULL, <span class="stringliteral">&quot;OK&quot;</span>, <span class="stringliteral">&quot;&quot;</span>),</div>
<div class="line">    datalogDiskSpacePopupID(0),</div>
<div class="line">    datalogDiskSpacePopupInfo(<span class="stringliteral">&quot;datalogDiskSpacePopup&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;Low Disk Space Warning&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;The robot disk filesystem containing the data log has less than 400 MB free space remaining.&quot;</span>,</div>
<div class="line">      ArServerHandlerPopup::WARNING,</div>
<div class="line">      1, 1, -1, NULL, <span class="stringliteral">&quot;OK&quot;</span>, <span class="stringliteral">&quot;&quot;</span>),</div>
<div class="line">    datalog(dl)</div>
<div class="line">  {</div>
<div class="line">    robot-&gt;addUserTask(<span class="stringliteral">&quot;arnlServerRobotMonitor&quot;</span>, 30, &amp;robotMonitorCB);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  ~RobotMonitor()</div>
<div class="line">  {</div>
<div class="line">    robot-&gt;remUserTask(&amp;robotMonitorCB);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keywordtype">void</span> setDataLogger(ArDataLogger *dl)</div>
<div class="line">  {</div>
<div class="line">    datalog = dl;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">  <span class="keywordtype">void</span> handleMotorsDisabledResponse(ArTypes::Byte4 popupID, <span class="keywordtype">int</span> button)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span>(button == 0)</div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Enabling motors...&quot;</span>);</div>
<div class="line">      robot-&gt;enableMotors();</div>
<div class="line">    }</div>
<div class="line">    popupServer-&gt;closePopup(motorsDisabledPopupID, <span class="stringliteral">&quot;Closing motor disable popup.&quot;</span>);</div>
<div class="line">    motorsDisabledPopupID = 0;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// This function is called as a robot task (every 100ms) to check on the robot</span></div>
<div class="line">  <span class="comment">// state and perform feedback and interact with user as needed.</span></div>
<div class="line">  <span class="keywordtype">void</span> robotMonitorTask()</div>
<div class="line">  {</div>
<div class="line"></div>
<div class="line">    <span class="comment">// a way for user to re-enable motors if disabled -- show a popup dialog in</span></div>
<div class="line">    <span class="comment">// MobileEyes.</span></div>
<div class="line">    <span class="keywordflow">if</span>(motorsDisabledPopupID == 0 &amp;&amp; robot &amp;&amp; !robot-&gt;areMotorsEnabled() &amp;&amp; robot-&gt;isConnected())</div>
<div class="line">    {</div>
<div class="line">      motorsDisabledPopupID = popupServer-&gt;createPopup(&amp;motorsDisabledPopupInfo, &amp;handleMotorsDisabledPopupResponseCB);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Set LX wheel light pattern based on robot activity. You could add more</span></div>
<div class="line">    <span class="comment">// conditions/light patterns here if you want.</span></div>
<div class="line">    <span class="keywordflow">if</span>(robot-&gt;isEStopPressed())</div>
<div class="line">      robot-&gt;comDataN(ArCommands::WHEEL_LIGHT, <span class="stringliteral">&quot;\x02\0\0\0&quot;</span>, 4); <span class="comment">// pattern #2, flash red</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!robot-&gt;areMotorsEnabled())</div>
<div class="line">      robot-&gt;comDataN(ArCommands::WHEEL_LIGHT, <span class="stringliteral">&quot;\x03\0\0\0&quot;</span>, 4); <span class="comment">// pattern #3, flash yellow</span></div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fabs(robot-&gt;getVel()) &lt; 5)</div>
<div class="line">      robot-&gt;comDataN(ArCommands::WHEEL_LIGHT, <span class="stringliteral">&quot;\x0A\0\0\0&quot;</span>, 4);  <span class="comment">// pattern #10, slow blue flash</span></div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      robot-&gt;comDataN(ArCommands::WHEEL_LIGHT, <span class="stringliteral">&quot;\x09\0\0\0&quot;</span>, 4);  <span class="comment">// pattern 9, blue sweep.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// warn about low disk space</span></div>
<div class="line">    <span class="keywordflow">if</span>(logDiskSpacePopupID == 0 &amp;&amp; ArLog::getAvailableDiskSpaceMB() &lt; 400)</div>
<div class="line">      logDiskSpacePopupID = popupServer-&gt;createPopup(&amp;logDiskSpacePopupInfo);</div>
<div class="line">    <span class="keywordflow">if</span>(datalog &amp;&amp; datalogDiskSpacePopupID == 0 &amp;&amp; datalog-&gt;getAvailableDiskSpaceMB() &lt; 400)</div>
<div class="line">      datalogDiskSpacePopupID = popupServer-&gt;createPopup(&amp;datalogDiskSpacePopupInfo);</div>
<div class="line">    </div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="comment">// Adds some &quot;custom commands&quot; to switch robot power outputs on/off</span></div>
<div class="line"><span class="keyword">class </span>SimpleComSwitchPower</div>
<div class="line">{</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line"><span class="preprocessor">#ifndef WIN32</span></div>
<div class="line"><span class="preprocessor"></span>  ArMTXIO mtxio;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    ArRobot *robot;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; mtxOnCB;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; mtxOffCB;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; seekurOnCB;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; seekurOffCB;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; patrolbotOnCB;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; patrolbotOffCB;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; resetCB;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; *onCmd;</div>
<div class="line">  ArFunctor1C&lt;SimpleComSwitchPower, ArArgumentBuilder*&gt; *offCmd;</div>
<div class="line">  <span class="keywordtype">void</span> switchMTX(ArArgumentBuilder *args, <span class="keywordtype">bool</span> state, <span class="keyword">const</span> <span class="keywordtype">char</span> *name = NULL);</div>
<div class="line">  <span class="keywordtype">void</span> mtxOn(ArArgumentBuilder *args);</div>
<div class="line">  <span class="keywordtype">void</span> mtxOff(ArArgumentBuilder *args);</div>
<div class="line">  <span class="keywordtype">void</span> seekurOn(ArArgumentBuilder *args);</div>
<div class="line">  <span class="keywordtype">void</span> seekurOff(ArArgumentBuilder *args);</div>
<div class="line">  <span class="keywordtype">void</span> patrolbotOn(ArArgumentBuilder *args);</div>
<div class="line">  <span class="keywordtype">void</span> patrolbotOff(ArArgumentBuilder *args);</div>
<div class="line">  <span class="keywordtype">void</span> reset(ArArgumentBuilder *args);</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">  SimpleComSwitchPower(ArServerHandlerCommands *commands, ArRobot *robot);</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">SimpleComSwitchPower::SimpleComSwitchPower(ArServerHandlerCommands *commands, ArRobot *_robot) :</div>
<div class="line">  robot(_robot),</div>
<div class="line">  mtxOnCB(this, &amp;SimpleComSwitchPower::mtxOn),</div>
<div class="line">  mtxOffCB(this, &amp;SimpleComSwitchPower::mtxOff),</div>
<div class="line">  seekurOnCB(this, &amp;SimpleComSwitchPower::seekurOn), </div>
<div class="line">  seekurOffCB(this, &amp;SimpleComSwitchPower::seekurOff), </div>
<div class="line">  patrolbotOnCB(this, &amp;SimpleComSwitchPower::patrolbotOn), </div>
<div class="line">  patrolbotOffCB(this, &amp;SimpleComSwitchPower::patrolbotOff), </div>
<div class="line">  resetCB(this, &amp;SimpleComSwitchPower::reset),</div>
<div class="line">  onCmd(NULL),</div>
<div class="line">  offCmd(NULL)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#ifndef WIN32</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span>(mtxio.isEnabled())</div>
<div class="line">  {</div>
<div class="line">    onCmd = &amp;mtxOnCB;</div>
<div class="line">    offCmd = &amp;mtxOffCB;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span>(robot &amp;&amp; (</div>
<div class="line">    strcasecmp(robot-&gt;getRobotSubType(), <span class="stringliteral">&quot;researchPB&quot;</span>) == 0 ||</div>
<div class="line">    strcasecmp(robot-&gt;getRobotSubType(), <span class="stringliteral">&quot;patrolbot-sh&quot;</span>) == 0 ||</div>
<div class="line">    strcasecmp(robot-&gt;getRobotSubType(), <span class="stringliteral">&quot;mt400&quot;</span>) == 0 ||</div>
<div class="line">    strcasecmp(robot-&gt;getRobotSubType(), <span class="stringliteral">&quot;guiabot&quot;</span>) == 0 ||</div>
<div class="line">    strcasecmp(robot-&gt;getRobotSubType(), <span class="stringliteral">&quot;mt490&quot;</span>) == 0)</div>
<div class="line">  )</div>
<div class="line">  {</div>
<div class="line">    onCmd = &amp;patrolbotOnCB;</div>
<div class="line">    offCmd = &amp;patrolbotOffCB;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(robot &amp;&amp; (</div>
<div class="line">    strcasecmp(robot-&gt;getRobotSubType(), <span class="stringliteral">&quot;seekur&quot;</span>) == 0 ||</div>
<div class="line">    strcasecmp(robot-&gt;getRobotSubType(), <span class="stringliteral">&quot;seekurjr&quot;</span>) == 0)</div>
<div class="line">  )</div>
<div class="line">  {</div>
<div class="line">    onCmd = &amp;seekurOnCB;</div>
<div class="line">    offCmd = &amp;seekurOffCB; </div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  </div>
<div class="line">  commands-&gt;addStringCommand(<span class="stringliteral">&quot;PowerOutputOn&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Switch on the given power output. For PioneerLX/MTX, specify {aux5v|aux12v|aux20v|user1|user2|user3} or &lt;bank&gt; &lt;bit&gt;.  For Seekur, specify &lt;port&gt;.  For PatrolBot, specify &lt;port&gt;.&quot;</span>,</div>
<div class="line">    onCmd</div>
<div class="line">  );</div>
<div class="line">  commands-&gt;addStringCommand(<span class="stringliteral">&quot;PowerOutputOff&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Switch off the given power output. For PioneerLX/MTX, specify {aux5v|aux12v|aux20v|user1|user2|user3} or &lt;bank&gt; &lt;bit&gt;.  For Seekur, specify &lt;port&gt;.  For PatrolBot, specify &lt;port&gt;.&quot;</span>,</div>
<div class="line">    offCmd</div>
<div class="line">  );</div>
<div class="line">  commands-&gt;addStringCommand(<span class="stringliteral">&quot;PowerOutputReset&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Toggle the given power output off, then on after a short delay. For PioneerLX/MTX, specify {aux5v|aux12v|aux20v|user1|user2|user3} or &lt;bank&gt; &lt;bit&gt;.  For Seekur, specify &lt;port&gt;.  For PatrolBot, specify &lt;port&gt;.&quot;</span>,</div>
<div class="line">    &amp;resetCB</div>
<div class="line">  );</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SimpleComSwitchPower::reset(ArArgumentBuilder *args)</div>
<div class="line">{</div>
<div class="line">  offCmd-&gt;invoke(args);</div>
<div class="line">  ArUtil::sleep(1000);</div>
<div class="line">  onCmd-&gt;invoke(args);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SimpleComSwitchPower::mtxOn(ArArgumentBuilder *args)</div>
<div class="line">{</div>
<div class="line">  switchMTX(args, <span class="keyword">true</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SimpleComSwitchPower::mtxOff(ArArgumentBuilder *args)</div>
<div class="line">{</div>
<div class="line">  switchMTX(args, <span class="keyword">false</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SimpleComSwitchPower::switchMTX(ArArgumentBuilder *args, <span class="keywordtype">bool</span> state, <span class="keyword">const</span> <span class="keywordtype">char</span> *name)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordtype">int</span> bank = 0;</div>
<div class="line">  <span class="keywordtype">int</span> bit = 0;</div>
<div class="line">  <span class="keywordflow">if</span>(args-&gt;getArgc() == 1)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span>(strcasecmp(args-&gt;getArg(0), <span class="stringliteral">&quot;aux5v&quot;</span>) == 0)</div>
<div class="line">    {</div>
<div class="line">      bank = 3; bit = 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcasecmp(args-&gt;getArg(0), <span class="stringliteral">&quot;aux12v&quot;</span>) == 0)</div>
<div class="line">    {</div>
<div class="line">      bank = 3; bit = 2;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcasecmp(args-&gt;getArg(0), <span class="stringliteral">&quot;aux20v&quot;</span>) == 0)</div>
<div class="line">    {</div>
<div class="line">      bank = 3; bit = 3;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcasecmp(args-&gt;getArg(0), <span class="stringliteral">&quot;user1&quot;</span>) == 0)</div>
<div class="line">    {</div>
<div class="line">      bank = 2; bit = 5;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcasecmp(args-&gt;getArg(0), <span class="stringliteral">&quot;user2&quot;</span>) == 0)</div>
<div class="line">    {</div>
<div class="line">      bank = 2; bit = 6;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(strcasecmp(args-&gt;getArg(0), <span class="stringliteral">&quot;user3&quot;</span>) == 0)</div>
<div class="line">    {</div>
<div class="line">      bank = 2; bit = 7;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">      ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: error: unrecognized name with PowerOutput command for LX/MTX. Must be one of: aux5v, aux12v, aux20v, user1, user2, user3.&quot;</span>) ;</div>
<div class="line">      <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    name = args-&gt;getArg(0);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> <span class="keywordflow">if</span>(args-&gt;getArgc() == 2)</div>
<div class="line">  {</div>
<div class="line">    bank = args-&gt;getArgInt(0);</div>
<div class="line">    bit = args-&gt;getArgInt(1);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: error: must give name or two arguments with PowerOutput command for LX/MTX.&quot;</span>) ;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#ifndef WIN32</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span>(!mtxio.isEnabled())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: error: not connected to MTX IO.&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">if</span>(name)</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: switching MTX %s (%d,%d) %s.&quot;</span>, name, bank, bit, state?<span class="stringliteral">&quot;on&quot;</span>:<span class="stringliteral">&quot;off&quot;</span>);</div>
<div class="line">  <span class="keywordflow">else</span></div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: switching MTX IO bank %d bit %d %s.&quot;</span>, bank, bit, state?<span class="stringliteral">&quot;on&quot;</span>:<span class="stringliteral">&quot;off&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span>(!mtxio.setPowerOutput(bank-1, bit, state))</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: error setting power output.&quot;</span>);</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SimpleComSwitchPower::seekurOn(ArArgumentBuilder *args)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(args-&gt;getArgc() != 1)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: no argument given with PowerOutput command.&quot;</span>) ;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordtype">int</span> p = args-&gt;getArgInt(0);</div>
<div class="line">  robot-&gt;lock();</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: Switching Seekur power port %d on.&quot;</span>, p);</div>
<div class="line">  robot-&gt;com2Bytes(116, p, 1);</div>
<div class="line">  robot-&gt;unlock();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SimpleComSwitchPower::seekurOff(ArArgumentBuilder *args)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(args-&gt;getArgc() != 1)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: no argument given with PowerOutput command.&quot;</span>); </div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordtype">int</span> p = args-&gt;getArgInt(0);</div>
<div class="line">  robot-&gt;lock();</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: Switching Seekur power port %d off.&quot;</span>, p);</div>
<div class="line">  robot-&gt;com2Bytes(116, p, 0);</div>
<div class="line">  robot-&gt;unlock();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SimpleComSwitchPower::patrolbotOn(ArArgumentBuilder *args)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(args-&gt;getArgc() != 1)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: no argument given with PowerOutput command.&quot;</span>) ;</div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordtype">int</span> p = args-&gt;getArgInt(0);</div>
<div class="line">  robot-&gt;lock();</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: Switching PatrolBot power port %d on.&quot;</span>, p);</div>
<div class="line">  robot-&gt;com2Bytes(31, p, 1);</div>
<div class="line">  robot-&gt;unlock();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> SimpleComSwitchPower::patrolbotOff(ArArgumentBuilder *args)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(args-&gt;getArgc() != 1)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: no argument given with PowerOutput command.&quot;</span>); </div>
<div class="line">    <span class="keywordflow">return</span>;</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordtype">int</span> p = args-&gt;getArgInt(0);</div>
<div class="line">  robot-&gt;lock();</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;SimpleComSwitchPower: Switching PatrolBot power port %d off.&quot;</span>, p);</div>
<div class="line">  robot-&gt;com2Bytes(31, p, 0);</div>
<div class="line">  robot-&gt;unlock();</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">bool</span> handleDebugMessage(ArRobotPacket *pkt)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(pkt-&gt;getID() != ArCommands::MARCDEBUG) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  <span class="keywordtype">char</span> msg[256];</div>
<div class="line">  pkt-&gt;bufToStr(msg, <span class="keyword">sizeof</span>(msg));</div>
<div class="line">  msg[255] = 0;</div>
<div class="line">  ArLog::log(ArLog::Terse, <span class="stringliteral">&quot;Controller Firmware: %s&quot;</span>, msg);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> reinitializeLocalization(ArRobot *robot, <a name="_a2"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerHandlerLocalization.html">ArServerHandlerLocalization</a> *locServer)</div>
<div class="line">{</div>
<div class="line">  locServer-&gt;<a name="a3"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerHandlerLocalization.html#ae3e3daac6a6abdda4c5225373c0e76d3">localizeToPose</a>(robot-&gt;getPose(), <span class="keyword">true</span>);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Program main function.</span></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">  <span class="comment">// Initialize Aria and Arnl global information</span></div>
<div class="line">  Aria::init();</div>
<div class="line">  Arnl::init();</div>
<div class="line"></div>
<div class="line">  <span class="comment">// You can change default ArLog options in this call, but the settings in the parameter file</span></div>
<div class="line">  <span class="comment">// (arnl.p) which is loaded below (Aria::getConfig()-&gt;parseFile())  will override the options.</span></div>
<div class="line">  <span class="comment">//ArLog::init(ArLog::File, ArLog::Normal, &quot;log.txt&quot;, true, true);</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Used to parse the command line arguments.</span></div>
<div class="line">  ArArgumentParser parser(&amp;argc, argv);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Load default arguments for this computer (from /etc/Aria.args, environment</span></div>
<div class="line">  <span class="comment">// variables, and other places)</span></div>
<div class="line">  parser.loadDefaultArguments();</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Tell the laser connector to always connect the first laser since</span></div>
<div class="line">  <span class="comment">// this program always requires a laser.</span></div>
<div class="line">  parser.addDefaultArgument(<span class="stringliteral">&quot;-connectLaser&quot;</span>);</div>
<div class="line"></div>
<div class="line">  </div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// The robot object</span></div>
<div class="line">  ArRobot robot;</div>
<div class="line"></div>
<div class="line">  <span class="comment">// This is an example of a user task callback. This is called every ArRobot</span></div>
<div class="line">  <span class="comment">// task cycle (every 100ms). The function is defined at the top of this file.</span></div>
<div class="line">  ArGlobalFunctor1&lt;ArRobot*&gt; robotTaskExampleCB(&amp;robotTaskExample, &amp;robot);</div>
<div class="line">  robot.addUserTask(<span class="stringliteral">&quot;arnlServerExampleTask&quot;</span>, 10, &amp;robotTaskExampleCB);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// handle messages from robot controller firmware and log the contents</span></div>
<div class="line">  robot.addPacketHandler(<span class="keyword">new</span> ArGlobalRetFunctor1&lt;bool, ArRobotPacket*&gt;(&amp;handleDebugMessage));</div>
<div class="line"></div>
<div class="line">  <span class="comment">// This object is used to connect to the robot, which can be configured via</span></div>
<div class="line">  <span class="comment">// command line arguments.</span></div>
<div class="line">  ArRobotConnector robotConnector(&amp;parser, &amp;robot);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Connect to the robot</span></div>
<div class="line">  <span class="keywordflow">if</span> (!robotConnector.connectRobot())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Error: Could not connect to robot... exiting&quot;</span>);</div>
<div class="line">    Aria::exit(3);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Set up where we&#39;ll look for files. Arnl::init() set Aria&#39;s default</span></div>
<div class="line">  <span class="comment">// directory to Arnl&#39;s default directory; addDirectories() appends this</span></div>
<div class="line">  <span class="comment">// &quot;examples&quot; directory.</span></div>
<div class="line">  <span class="keywordtype">char</span> fileDir[1024];</div>
<div class="line">  ArUtil::addDirectories(fileDir, <span class="keyword">sizeof</span>(fileDir), Aria::getDirectory(), </div>
<div class="line">             <span class="stringliteral">&quot;examples&quot;</span>);</div>
<div class="line">  </div>
<div class="line">  </div>
<div class="line">  <span class="comment">// To direct log messages to a file, or to change the log level, use these  calls:</span></div>
<div class="line">  <span class="comment">//ArLog::init(ArLog::File, ArLog::Normal, &quot;log.txt&quot;, true, true);</span></div>
<div class="line">  <span class="comment">//ArLog::init(ArLog::File, ArLog::Verbose);</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add a section to the configuration to change ArLog parameters</span></div>
<div class="line">  ArLog::addToConfig(Aria::getConfig());</div>
<div class="line"></div>
<div class="line">  <span class="comment">// set up a gyro (if the robot is older and its firmware does not</span></div>
<div class="line">  <span class="comment">// automatically incorporate gyro corrections, then this object will do it)</span></div>
<div class="line">  ArAnalogGyro gyro(&amp;robot);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Our networking server</span></div>
<div class="line">  ArServerBase server;</div>
<div class="line">  </div>
<div class="line"></div>
<div class="line">  <span class="comment">// Set up our simpleOpener, used to set up the networking server</span></div>
<div class="line">  ArServerSimpleOpener simpleOpener(&amp;parser);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// the laser connector</span></div>
<div class="line">  ArLaserConnector laserConnector(&amp;parser, &amp;robot, &amp;robotConnector);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Load default arguments for this computer (from /etc/Aria.args, environment</span></div>
<div class="line">  <span class="comment">// variables, and other places)</span></div>
<div class="line">  parser.loadDefaultArguments();</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Parse arguments </span></div>
<div class="line">  <span class="keywordflow">if</span> (!Aria::parseArgs() || !parser.checkHelpAndWarnUnparsed())</div>
<div class="line">  {</div>
<div class="line">    logOptions(argv[0]);</div>
<div class="line">    Aria::exit(1);</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line"></div>
<div class="line">  <span class="comment">// This causes Aria::exit(9) to be called if the robot unexpectedly</span></div>
<div class="line">  <span class="comment">// disconnects</span></div>
<div class="line">  ArGlobalFunctor1&lt;int&gt; shutdownFunctor(&amp;Aria::exit, 9);</div>
<div class="line">  robot.addDisconnectOnErrorCB(&amp;shutdownFunctor);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Create an ArSonarDevice object (ArRangeDevice subclass) and </span></div>
<div class="line">  <span class="comment">// connect it to the robot.</span></div>
<div class="line">  ArSonarDevice sonarDev;</div>
<div class="line">  robot.addRangeDevice(&amp;sonarDev);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// This object will allow robot&#39;s movement parameters to be changed through</span></div>
<div class="line">  <span class="comment">// a Robot Configuration section in the ArConfig global configuration facility.</span></div>
<div class="line">  ArRobotConfig robotConfig(&amp;robot);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Include gyro configuration options in the robot configuration section.</span></div>
<div class="line">  robotConfig.addAnalogGyro(&amp;gyro);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Start the robot thread.</span></div>
<div class="line">  robot.runAsync(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">  </div>
<div class="line"></div>
<div class="line">  <span class="comment">// connect the laser(s) if it was requested, this adds them to the</span></div>
<div class="line">  <span class="comment">// robot too, and starts them running in their own threads</span></div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Connecting to laser(s) configured in parameters...&quot;</span>);</div>
<div class="line">  <span class="keywordflow">if</span> (!laserConnector.connectLasers())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Error: Could not connect to laser(s). Exiting.&quot;</span>);</div>
<div class="line">    Aria::exit(2);</div>
<div class="line">  }</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Done connecting to laser(s).&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// find the laser we should use for localization and/or mapping,</span></div>
<div class="line">  <span class="comment">// which will be the first laser</span></div>
<div class="line">  robot.lock();</div>
<div class="line">  ArLaser *firstLaser = robot.findLaser(1);</div>
<div class="line">  <span class="keywordflow">if</span> (firstLaser == NULL || !firstLaser-&gt;isConnected())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Did not have laser 1 or it is not connected, cannot start localization and/or mapping... exiting&quot;</span>);</div>
<div class="line">    Aria::exit(2);</div>
<div class="line">  }</div>
<div class="line">  robot.unlock();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create and set up map object */</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Set up the map object, this will look for files in the examples</span></div>
<div class="line">  <span class="comment">// directory (unless the file name starts with a /, \, or .</span></div>
<div class="line">  <span class="comment">// You can take out the &#39;fileDir&#39; argument to look in the program&#39;s current directory</span></div>
<div class="line">  <span class="comment">// instead.</span></div>
<div class="line">  <span class="comment">// When a configuration file is loaded into ArConfig later, if it specifies a</span></div>
<div class="line">  <span class="comment">// map file, then that file will be loaded as the map.</span></div>
<div class="line">  ArMap map(fileDir);</div>
<div class="line">  <span class="comment">// set it up to ignore empty file names (otherwise if a configuration omits</span></div>
<div class="line">  <span class="comment">// the map file, the whole configuration change will fail)</span></div>
<div class="line">  map.setIgnoreEmptyFileName(<span class="keyword">true</span>);</div>
<div class="line">  <span class="comment">// ignore the case, so that if someone is using MobileEyes or</span></div>
<div class="line">  <span class="comment">// MobilePlanner from Windows and changes the case on a map name,</span></div>
<div class="line">  <span class="comment">// it will still work.</span></div>
<div class="line">  map.setIgnoreCase(<span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Create localization and path planning threads */</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html">ArPathPlanningTask</a> pathTask(&amp;robot, &amp;sonarDev, &amp;map);</div>
<div class="line"><span class="comment">//  pathPlanningTask = &amp;pathTask;</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">// The following are callback functions that pathTask will call </span></div>
<div class="line">  <span class="comment">// on certain events such as reaching a goal, failing to reach a goal, etc.</span></div>
<div class="line">  <span class="comment">// The functions are defined at the top of this file. You can add code there</span></div>
<div class="line">  <span class="comment">// to take some action such as control something on the robot, choose the next</span></div>
<div class="line">  <span class="comment">// goal, send output elsewhele, etc.</span></div>
<div class="line">  ArGlobalFunctor1&lt;ArPose&gt; <span class="comment">/*, ArPathPlanningTask*&gt;*/</span> goalDoneCB(&amp;goalDone); <span class="comment">//, &amp;pathTask);</span></div>
<div class="line">  pathTask.addGoalDoneCB(&amp;goalDoneCB);</div>
<div class="line"></div>
<div class="line">  ArGlobalFunctor1&lt;ArPose&gt; <span class="comment">/*, ArPathPlanningTask*&gt;*/</span> goalFailedCB(&amp;goalFailed); <span class="comment">//, &amp;pathTask);</span></div>
<div class="line">  pathTask.addGoalFailedCB(&amp;goalFailedCB);</div>
<div class="line"></div>
<div class="line">  ArGlobalFunctor1&lt;ArPathPlanningTask*&gt; stateCB(&amp;pathPlanStateChanged, &amp;pathTask);</div>
<div class="line">  pathTask.addStateChangeCB(&amp;stateCB);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Creating laser localization task&quot;</span>);</div>
<div class="line">  <span class="comment">// Laser Monte-Carlo Localization</span></div>
<div class="line">  <a name="_a4"></a><a class="code" href="classArLocalizationTask.html" title="Task that performs continuous localization of the robot with a laser range sensor in a seperate async...">ArLocalizationTask</a> locTask(&amp;robot, firstLaser, &amp;map);</div>
<div class="line">  </div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// A callback function, which is called if localization fails</span></div>
<div class="line">  ArGlobalFunctor1&lt;int&gt; locFailedCB(&amp;locFailed);</div>
<div class="line">  locTask.setFailedCallBack(&amp;locFailedCB); <span class="comment">//, &amp;locTask);</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Set some options  and callbacks on each laser that the laser connector </span></div>
<div class="line">  <span class="comment">// connected to.</span></div>
<div class="line">  std::map&lt;int, ArLaser *&gt;::iterator laserIt;</div>
<div class="line">  <span class="keywordflow">for</span> (laserIt = robot.getLaserMap()-&gt;begin();</div>
<div class="line">       laserIt != robot.getLaserMap()-&gt;end();</div>
<div class="line">       laserIt++)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordtype">int</span> laserNum = (*laserIt).first;</div>
<div class="line">    ArLaser *laser = (*laserIt).second;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Skip lasers that aren&#39;t connected</span></div>
<div class="line">    <span class="keywordflow">if</span>(!laser-&gt;isConnected())</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// add the disconnectOnError CB to shut things down if the laser</span></div>
<div class="line">    <span class="comment">// connection is lost</span></div>
<div class="line">    laser-&gt;addDisconnectOnErrorCB(&amp;shutdownFunctor);</div>
<div class="line">    <span class="comment">// set the number of cumulative readings the laser will take</span></div>
<div class="line">    laser-&gt;setCumulativeBufferSize(200);</div>
<div class="line">    <span class="comment">// add the lasers to the path planning task</span></div>
<div class="line">    pathTask.addRangeDevice(laser, <a name="a5"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html#a875d3414ba11ffb584fcb0a71925c9c1a7c8d8c749a1ac37018a7fe136b7a1fc7">ArPathPlanningTask::BOTH</a>);</div>
<div class="line">    <span class="comment">// set the cumulative clean offset (so that they don&#39;t all fire at once)</span></div>
<div class="line">    laser-&gt;setCumulativeCleanOffset(laserNum * 100);</div>
<div class="line">    <span class="comment">// reset the cumulative clean time (to make the new offset take effect)</span></div>
<div class="line">    laser-&gt;resetLastCumulativeCleanTime();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Add the packet count to the Aria info strings (It will be included in</span></div>
<div class="line">    <span class="comment">// MobileEyes custom details so you can monitor whether the laser data is</span></div>
<div class="line">    <span class="comment">// being received correctly)</span></div>
<div class="line">    std::string laserPacketCountName;</div>
<div class="line">    laserPacketCountName = laser-&gt;getName();</div>
<div class="line">    laserPacketCountName += <span class="stringliteral">&quot; Packet Count&quot;</span>;</div>
<div class="line">    Aria::getInfoGroup()-&gt;addStringInt(</div>
<div class="line">        laserPacketCountName.c_str(), 10, </div>
<div class="line">        <span class="keyword">new</span> ArRetFunctorC&lt;int, ArLaser&gt;(laser, </div>
<div class="line">                     &amp;ArLaser::getReadingCount));</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Start the server */</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Open the networking server</span></div>
<div class="line">  <span class="keywordflow">if</span> (!simpleOpener.open(&amp;server, fileDir, 240))</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Error: Could not open server.&quot;</span>);</div>
<div class="line">    exit(2);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Create various services that provide network access to clients (such as</span></div>
<div class="line"><span class="comment">     * MobileEyes), as well as add various additional features to ARNL */</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Add additional range devices to the robot and path planning task (so it</span></div>
<div class="line"><span class="comment">     avoids obstacles detected by these devices) */</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Add IR range device to robot and path planning task (so it avoids obstacles</span></div>
<div class="line">  <span class="comment">// detected by this device)</span></div>
<div class="line">  robot.lock();</div>
<div class="line">  ArIRs irs;</div>
<div class="line">  robot.addRangeDevice(&amp;irs);</div>
<div class="line">  pathTask.addRangeDevice(&amp;irs, <a name="a6"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html#a875d3414ba11ffb584fcb0a71925c9c1a2a5147c60a29a83554a68187a46bfad5">ArPathPlanningTask::CURRENT</a>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Add bumpers range device to robot and path planning task (so it avoids obstacles</span></div>
<div class="line">  <span class="comment">// detected by this device)</span></div>
<div class="line">  ArBumpers bumpers;</div>
<div class="line">  robot.addRangeDevice(&amp;bumpers);</div>
<div class="line">  pathTask.addRangeDevice(&amp;bumpers, <a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html#a875d3414ba11ffb584fcb0a71925c9c1a2a5147c60a29a83554a68187a46bfad5">ArPathPlanningTask::CURRENT</a>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Add range device which uses forbidden regions given in the map to give virtual</span></div>
<div class="line">  <span class="comment">// range device readings to ARNL.  (so it avoids obstacles</span></div>
<div class="line">  <span class="comment">// detected by this device)</span></div>
<div class="line">  ArForbiddenRangeDevice forbidden(&amp;map);</div>
<div class="line">  robot.addRangeDevice(&amp;forbidden);</div>
<div class="line">  pathTask.addRangeDevice(&amp;forbidden, <a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html#a875d3414ba11ffb584fcb0a71925c9c1a2a5147c60a29a83554a68187a46bfad5">ArPathPlanningTask::CURRENT</a>);</div>
<div class="line"></div>
<div class="line">  robot.unlock();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Action to slow down robot when localization score drops but not lost.</span></div>
<div class="line">  ArActionSlowDownWhenNotCertain actionSlowDown(&amp;locTask);</div>
<div class="line">  pathTask.getPathPlanActionGroup()-&gt;addAction(&amp;actionSlowDown, 140);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Action to stop the robot when localization is &quot;lost&quot; (score too low)</span></div>
<div class="line">  <a name="_a7"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArActionLost.html">ArActionLost</a> actionLostPath(&amp;locTask, &amp;pathTask);</div>
<div class="line">  pathTask.getPathPlanActionGroup()-&gt;addAction(&amp;actionLostPath, 150);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Arnl uses this object when it must replan its path because its</span></div>
<div class="line">  <span class="comment">// path is completely blocked.  It will use an older history of sensor</span></div>
<div class="line">  <span class="comment">// readings to replan this new path.  This should not be used with SONARNL</span></div>
<div class="line">  <span class="comment">// since sonar readings are not accurate enough and may prevent the robot</span></div>
<div class="line">  <span class="comment">// from planning through space that is actually clear.</span></div>
<div class="line">  <a name="_a8"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArGlobalReplanningRangeDevice.html">ArGlobalReplanningRangeDevice</a> replanDev(&amp;pathTask);</div>
<div class="line"></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// Service to provide drawings of data in the map display :</span></div>
<div class="line">  ArServerInfoDrawings drawings(&amp;server);</div>
<div class="line">  drawings.addRobotsRangeDevices(&amp;robot);</div>
<div class="line">  drawings.addRangeDevice(&amp;replanDev);</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Draw a box around the local path planning area use this </span></div>
<div class="line"><span class="comment">    (You can enable this particular drawing from custom commands </span></div>
<div class="line"><span class="comment">    which is set up down below in ArServerInfoPath) */</span></div>
<div class="line">  ArDrawingData drawingDataP(<span class="stringliteral">&quot;polyLine&quot;</span>, ArColor(200,200,200), 1, 75);</div>
<div class="line">  ArFunctor2C&lt;ArPathPlanningTask, ArServerClient *, ArNetPacket *&gt; </div>
<div class="line">    drawingFunctorP(&amp;pathTask, &amp;<a name="a9"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html#afdd2605b2aedfc6299ab9ca9c0800464">ArPathPlanningTask::drawSearchRectangle</a>);</div>
<div class="line">  drawings.addDrawing(&amp;drawingDataP, <span class="stringliteral">&quot;Local Plan Area&quot;</span>, &amp;drawingFunctorP); </div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Draw a box showing the safety clearance used by the path planning task to */</span></div>
<div class="line">  drawings.addDrawing(</div>
<div class="line">    <span class="keyword">new</span> ArDrawingData(<span class="stringliteral">&quot;polySegments&quot;</span>, ArColor(166, 166, 166), 1, 60, 100, <span class="stringliteral">&quot;DefaultOn&quot;</span>),</div>
<div class="line">    <span class="stringliteral">&quot;Path Planning Clearances&quot;</span>,</div>
<div class="line">    <span class="keyword">new</span> ArFunctor2C&lt;ArPathPlanningTask, ArServerClient*, ArNetPacket*&gt;(&amp;pathTask, &amp;<a name="a10"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPathPlanningTask.html#a5209bdcce25df07242695f77c20096f3">ArPathPlanningTask::drawRobotBounds</a>)</div>
<div class="line">  );</div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Show the sample points used by MCL */</span></div>
<div class="line">  ArDrawingData drawingDataL(<span class="stringliteral">&quot;polyDots&quot;</span>, ArColor(0,255,0), 100, 75);</div>
<div class="line">  ArFunctor2C&lt;ArLocalizationTask, ArServerClient *, ArNetPacket *&gt; </div>
<div class="line">    drawingFunctorL(&amp;locTask, &amp;<a name="a11"></a><a class="code" href="classArLocalizationTask.html#a106eada91144e31e6c9999f2130bb98f" title="Draws range data used for localization.">ArLocalizationTask::drawRangePoints</a>);</div>
<div class="line">  drawings.addDrawing(&amp;drawingDataL, <span class="stringliteral">&quot;Localization Points&quot;</span>, &amp;drawingFunctorL);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// &quot;Custom&quot; commands. You can add your own custom commands here, they will</span></div>
<div class="line">  <span class="comment">// be available in MobileEyes&#39; custom commands (enable in the toolbar or</span></div>
<div class="line">  <span class="comment">// access through Robot Tools)</span></div>
<div class="line">  ArServerHandlerCommands commands(&amp;server);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// These provide various kinds of information to the client:</span></div>
<div class="line">  ArServerInfoRobot serverInfoRobot(&amp;server, &amp;robot);</div>
<div class="line">  ArServerInfoSensor serverInfoSensor(&amp;server, &amp;robot);</div>
<div class="line">  <a name="_a12"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerInfoPath.html">ArServerInfoPath</a> serverInfoPath(&amp;server, &amp;robot, &amp;pathTask);</div>
<div class="line">  serverInfoPath.addSearchRectangleDrawing(&amp;drawings);</div>
<div class="line">  serverInfoPath.addControlCommands(&amp;commands);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Provides localization info and allows the client (MobileEyes) to relocalize at a given</span></div>
<div class="line">  <span class="comment">// pose:</span></div>
<div class="line">  <a name="_a13"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerInfoLocalization.html">ArServerInfoLocalization</a> serverInfoLocalization(&amp;server, &amp;robot, &amp;locTask);</div>
<div class="line">  <a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerHandlerLocalization.html">ArServerHandlerLocalization</a> serverLocHandler(&amp;server, &amp;robot, &amp;locTask);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// If you&#39;re using MobileSim, ArServerHandlerLocalization sends it a command</span></div>
<div class="line">  <span class="comment">// to move the robot&#39;s true pose if you manually do a localization through </span></div>
<div class="line">  <span class="comment">// MobileEyes.  To disable that behavior, use this constructor call instead:</span></div>
<div class="line">  <span class="comment">// ArServerHandlerLocalization serverLocHandler(&amp;server, &amp;robot, true, false);</span></div>
<div class="line">  <span class="comment">// The fifth argument determines whether to send the command to MobileSim.</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Provide the map to the client (and related controls):</span></div>
<div class="line">  ArServerHandlerMap serverMap(&amp;server, &amp;map);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// These objects add some simple (custom) commands to &#39;commands&#39; for testing and debugging:</span></div>
<div class="line">  ArServerSimpleComUC uCCommands(&amp;commands, &amp;robot);                   <span class="comment">// Send any command to the microcontroller</span></div>
<div class="line">  ArServerSimpleComMovementLogging loggingCommands(&amp;commands, &amp;robot); <span class="comment">// configure logging</span></div>
<div class="line">  ArServerSimpleComLogRobotConfig configCommands(&amp;commands, &amp;robot);   <span class="comment">// trigger logging of the robot config parameters</span></div>
<div class="line"><span class="comment">//  ArServerSimpleServerCommands serverCommands(&amp;commands, &amp;server);     // monitor networking behavior (track packets sent etc.)</span></div>
<div class="line"></div>
<div class="line">  </div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// service that allows the client to monitor the communication link status</span></div>
<div class="line">  <span class="comment">// between the robot and the client.</span></div>
<div class="line">  <span class="comment">//</span></div>
<div class="line">  ArServerHandlerCommMonitor handlerCommMonitor(&amp;server);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// service that allows client to change configuration parameters in ArConfig </span></div>
<div class="line">  ArServerHandlerConfig handlerConfig(&amp;server, Aria::getConfig(),</div>
<div class="line">                      Arnl::getTypicalDefaultParamFileName(),</div>
<div class="line">                      Aria::getDirectory());</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// This service causes the client to show simple dialog boxes</span></div>
<div class="line">  ArServerHandlerPopup popupServer(&amp;server);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Monitor the robot for current state such as if the motors are disabled,</span></div>
<div class="line">  <span class="comment">// indicate this state by various means and show a popup dialog on clients</span></div>
<div class="line">  <span class="comment">// if user confirmation is needed.</span></div>
<div class="line">  <span class="comment">// (Namely, some robots  disable motors automatically on various error conditions,</span></div>
<div class="line">  <span class="comment">// and we want the user to manually re-enable them after resolving the</span></div>
<div class="line">  <span class="comment">// problem)</span></div>
<div class="line">  RobotMonitor robotMonitor(&amp;robot, &amp;popupServer);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Set up the possible modes for remote control from a client such as</span></div>
<div class="line"><span class="comment">   * MobileEyes:</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Mode To go to a goal or other specific point:</span></div>
<div class="line">  <a name="_a14"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerModeGoto.html">ArServerModeGoto</a> modeGoto(&amp;server, &amp;robot, &amp;pathTask, &amp;map,</div>
<div class="line">                locTask.getRobotHome(),</div>
<div class="line">                locTask.getRobotHomeCallback());</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Add a special command to Custom Commands that tours a list of goals rather</span></div>
<div class="line">  <span class="comment">// than all:</span></div>
<div class="line">  modeGoto.<a name="a15"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArServerModeGoto.html#afbd42b7b40058cd0c2f849103a40e9b8">addTourGoalsInListSimpleCommand</a>(&amp;commands);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Mode To stop and remain stopped:</span></div>
<div class="line">  ArServerModeStop modeStop(&amp;server, &amp;robot);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Cause the sonar to turn off automatically</span></div>
<div class="line">  <span class="comment">// when the robot is stopped, and turn it back on when commands to move</span></div>
<div class="line">  <span class="comment">// are sent. (Note, if using SONARNL to localize, then don&#39;t do this</span></div>
<div class="line">  <span class="comment">// since localization may get lost)</span></div>
<div class="line">  ArSonarAutoDisabler sonarAutoDisabler(&amp;robot);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Teleoperation modes To drive by keyboard, joystick, etc:</span></div>
<div class="line">  ArServerModeRatioDrive modeRatioDrive(&amp;server, &amp;robot);  </div>
<div class="line"><span class="comment">//  ArServerModeDrive modeDrive(&amp;server, &amp;robot);            // Older mode for compatability</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Prevent normal teleoperation driving if localization is lost using</span></div>
<div class="line">  <span class="comment">// a high-priority action, which enables itself when the particular mode is</span></div>
<div class="line">  <span class="comment">// active.</span></div>
<div class="line">  <span class="comment">// (You have to enter unsafe drive mode to drive when lost.)</span></div>
<div class="line">  <a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArActionLost.html">ArActionLost</a> actionLostRatioDrive(&amp;locTask, &amp;pathTask, &amp;modeRatioDrive);</div>
<div class="line">  modeRatioDrive.getActionGroup()-&gt;addAction(&amp;actionLostRatioDrive, 110);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Add drive mode section to the configuration, and also some custom (simple) commands:</span></div>
<div class="line">  modeRatioDrive.addToConfig(Aria::getConfig(), <span class="stringliteral">&quot;Teleop settings&quot;</span>);</div>
<div class="line">  modeRatioDrive.addControlCommands(&amp;commands);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Wander mode (also prevent wandering if lost):</span></div>
<div class="line">  ArServerModeWander modeWander(&amp;server, &amp;robot);</div>
<div class="line">  <a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArActionLost.html">ArActionLost</a> actionLostWander(&amp;locTask, &amp;pathTask, &amp;modeWander);</div>
<div class="line">  modeWander.getActionGroup()-&gt;addAction(&amp;actionLostWander, 110);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Jog position mode</span></div>
<div class="line">  ArServerModeJogPosition modeJog(&amp;server, &amp;robot);</div>
<div class="line">  modeJog.addToConfig(Aria::getConfig());</div>
<div class="line">  modeJog.addCommands(&amp;commands);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Tool to log data periodically to a file</span></div>
<div class="line">  ArDataLogger dataLogger(&amp;robot, <span class="stringliteral">&quot;datalog.txt&quot;</span>);</div>
<div class="line">  dataLogger.addToConfig(Aria::getConfig()); <span class="comment">// make it configurable through ArConfig</span></div>
<div class="line">  robotMonitor.setDataLogger(&amp;dataLogger);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Custom command to write a comment to the data log</span></div>
<div class="line">  commands.addStringCommand(<span class="stringliteral">&quot;DataLogger:InsertComment&quot;</span>, <span class="stringliteral">&quot;Write a message to the data log as a comment. Data Logging must be enabled in config.&quot;</span>, dataLogger.getWriteCommentFunctor());</div>
<div class="line"></div>
<div class="line">  <span class="comment">// This provides a small table of interesting information for the client</span></div>
<div class="line">  <span class="comment">// to display to the operator. You can add your own callbacks to show any</span></div>
<div class="line">  <span class="comment">// data you want.</span></div>
<div class="line">  ArServerInfoStrings stringInfo(&amp;server);</div>
<div class="line">  Aria::getInfoGroup()-&gt;addAddStringCallback(stringInfo.getAddStringFunctor());</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Automatically add anything from the global info group to the data logger.</span></div>
<div class="line">  Aria::getInfoGroup()-&gt;addAddStringCallback(dataLogger.getAddStringFunctor());</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// The following statements add fields to a set of informational data called</span></div>
<div class="line">  <span class="comment">// the InfoGroup. These are served to MobileEyes for displayi (turn on by enabling Details</span></div>
<div class="line">  <span class="comment">// and Custom Details in the View menu of MobileEyes.)</span></div>
<div class="line"></div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringInt(</div>
<div class="line">      <span class="stringliteral">&quot;Motor Packet Count&quot;</span>, 10, </div>
<div class="line">      <span class="keyword">new</span> ArConstRetFunctorC&lt;int, ArRobot&gt;(&amp;robot, </div>
<div class="line">                           &amp;ArRobot::getMotorPacCount));</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span>(robotConnector.getRemoteIsSim())</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Connected to simulator, simulator info will be available for display and logging.&quot;</span>);</div>
<div class="line">    ArSimUtil *sim = <span class="keyword">new</span> ArSimUtil(&amp;robot);</div>
<div class="line">    Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;Sim True X&quot;</span>, 8, </div>
<div class="line">      <span class="keyword">new</span> ArRetFunctorC&lt;double, ArSimUtil&gt;(sim, &amp;ArSimUtil::getSimTrueX));</div>
<div class="line">    Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;Sim True Y&quot;</span>, 8, </div>
<div class="line">      <span class="keyword">new</span> ArRetFunctorC&lt;double, ArSimUtil&gt;(sim, &amp;ArSimUtil::getSimTrueY)); </div>
<div class="line">    Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;Sim True Th&quot;</span>, 6, </div>
<div class="line">      <span class="keyword">new</span> ArRetFunctorC&lt;double, ArSimUtil&gt;(sim, &amp;ArSimUtil::getSimTrueTh));</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringDouble(</div>
<div class="line">      <span class="stringliteral">&quot;Laser Loc Score&quot;</span>, 8, </div>
<div class="line">      <span class="keyword">new</span> ArRetFunctorC&lt;double, ArLocalizationTask&gt;(</div>
<div class="line">          &amp;locTask, &amp;<a name="a16"></a><a class="code" href="classArLocalizationTask.html#a17ff3d74dfa7cd4955c284a954e2ba03" title="Gets the higher of MCL and Reflector based localization.">ArLocalizationTask::getLocalizationScore</a>),</div>
<div class="line">      <span class="stringliteral">&quot;%.03f&quot;</span>);</div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringBool(</div>
<div class="line">      <span class="stringliteral">&quot;Laser Loc Lost&quot;</span>, 8, </div>
<div class="line">      <span class="keyword">new</span> ArRetFunctorC&lt;bool, ArLocalizationTask&gt;(</div>
<div class="line">          &amp;locTask, &amp;<a name="a17"></a><a class="code" href="classArLocalizationTask.html#a089dd38a26726544962e01061208c7b0" title="Gets the lost flag.">ArLocalizationTask::getRobotIsLostFlag</a>));</div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringBool(</div>
<div class="line">      <span class="stringliteral">&quot;Laser Loc Idle&quot;</span>, 8, </div>
<div class="line">      <span class="keyword">new</span> ArRetFunctorC&lt;bool, ArLocalizationTask&gt;(</div>
<div class="line">          &amp;locTask, &amp;<a name="a18"></a><a class="code" href="classArLocalizationTask.html#a75ca4c7df9fd4c8656dc2b80f42b56be" title="Gets the idle flag.">ArLocalizationTask::getIdleFlag</a>));</div>
<div class="line"></div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringInt(</div>
<div class="line">      <span class="stringliteral">&quot;Laser Loc Num Samples&quot;</span>, 8, </div>
<div class="line">      <span class="keyword">new</span> ArRetFunctorC&lt;int, ArLocalizationTask&gt;(</div>
<div class="line">          &amp;locTask, &amp;<a name="a19"></a><a class="code" href="classArLocalizationTask.html#af05fb6f78dbb52b3937698ef467e3d1a" title="Get the variable number of samples if adjusted during move.">ArLocalizationTask::getCurrentNumSamples</a>),</div>
<div class="line">      <span class="stringliteral">&quot;%4d&quot;</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Display gyro status if gyro is enabled and is being handled by the firmware (gyro types 2, 3, or 4).</span></div>
<div class="line">  <span class="comment">// (If the firmware detects an error communicating with the gyro or IMU it</span></div>
<div class="line">  <span class="comment">// returns a flag, and stops using it.)</span></div>
<div class="line">  <span class="comment">// (This gyro type parameter, and fault flag, are only in ARCOS, not Seekur firmware)</span></div>
<div class="line">  <span class="keywordflow">if</span>(robot.getOrigRobotConfig() &amp;&amp; robot.getOrigRobotConfig()-&gt;getGyroType() &gt; 1)</div>
<div class="line">  {</div>
<div class="line">    Aria::getInfoGroup()-&gt;addStringString(</div>
<div class="line">          <span class="stringliteral">&quot;Gyro/IMU Status&quot;</span>, 10,</div>
<div class="line">          <span class="keyword">new</span> ArGlobalRetFunctor1&lt;const char*, ArRobot*&gt;(&amp;getGyroStatusString, &amp;robot)</div>
<div class="line">      );</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Display system CPU and wireless network status</span></div>
<div class="line">  ArSystemStatus::startPeriodicUpdate(1000); <span class="comment">// update every 1 second</span></div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;CPU Use&quot;</span>, 10, ArSystemStatus::getCPUPercentFunctor(), <span class="stringliteral">&quot;% 4.0f%%&quot;</span>);</div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringInt(<span class="stringliteral">&quot;Wireless Link Quality&quot;</span>, 9, ArSystemStatus::getWirelessLinkQualityFunctor(), <span class="stringliteral">&quot;%d&quot;</span>);</div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringInt(<span class="stringliteral">&quot;Wireless Link Noise&quot;</span>, 9, ArSystemStatus::getWirelessLinkNoiseFunctor(), <span class="stringliteral">&quot;%d&quot;</span>);</div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringInt(<span class="stringliteral">&quot;Wireless Signal&quot;</span>, 9, ArSystemStatus::getWirelessLinkSignalFunctor(), <span class="stringliteral">&quot;%d&quot;</span>);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">// log status</span></div>
<div class="line">  Aria::getInfoGroup()-&gt;addString(<span class="stringliteral">&quot;Data Log Status&quot;</span>, 24, <span class="keyword">new</span> ArFunctor2C&lt;ArDataLogger, char*, ArTypes::UByte2&gt;(&amp;dataLogger, &amp;ArDataLogger::getStatus));</div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringUnsignedLong(<span class="stringliteral">&quot;Data Log Disk Free Space&quot;</span>, 10, <span class="keyword">new</span> ArRetFunctorC&lt;unsigned long, ArDataLogger&gt;(&amp;dataLogger, &amp;ArDataLogger::getAvailableDiskSpaceMB), <span class="stringliteral">&quot;%lu MB&quot;</span>);</div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringUnsignedLong(<span class="stringliteral">&quot;Log Disk Free Space&quot;</span>, 10, <span class="keyword">new</span> ArGlobalRetFunctor&lt;unsigned long&gt;(&amp;ArLog::getAvailableDiskSpaceMB), <span class="stringliteral">&quot;%lu MB&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// stats on how far its driven since software started</span></div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;Distance Travelled (m)&quot;</span>, 20, <span class="keyword">new</span> ArRetFunctorC&lt;double, ArRobot&gt;(&amp;robot, &amp;ArRobot::getOdometerDistanceMeters), <span class="stringliteral">&quot;%.2f&quot;</span>);</div>
<div class="line">  Aria::getInfoGroup()-&gt;addStringDouble(<span class="stringliteral">&quot;Run time (min)&quot;</span>, 20, <span class="keyword">new</span></div>
<div class="line">ArRetFunctorC&lt;double, ArRobot&gt;(&amp;robot, &amp;ArRobot::getOdometerTimeMinutes),</div>
<div class="line"><span class="stringliteral">&quot;%.2f&quot;</span>);</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Setup the dock if there is a docking system on board.</span></div>
<div class="line">  <a name="_a20"></a><a class="code" href="classArServerModeDock.html" title="Base class to manage docking.">ArServerModeDock</a> *modeDock = NULL;</div>
<div class="line">  modeDock = <a name="a21"></a><a class="code" href="classArServerModeDock.html#a3a43ce1b33e3fa56bdef6df21a2b4d09" title="This will create a dock of the appropriate type for the robot.">ArServerModeDock::createDock</a>(&amp;server, &amp;robot, &amp;locTask, </div>
<div class="line">                      &amp;pathTask, NULL, &amp;parser);</div>
<div class="line">  <span class="keywordflow">if</span> (modeDock != NULL)</div>
<div class="line">  {</div>
<div class="line">    modeDock-&gt;<a name="a22"></a><a class="code" href="classArServerModeDock.html#a652e2ec28feb5fa0a8614499c0bf29f2" title="Sees if the robot is already docked and activates itself if it is (subclass should implement)...">checkDock</a>();</div>
<div class="line">    modeDock-&gt;addAsDefaultMode();</div>
<div class="line">    modeDock-&gt;<a name="a23"></a><a class="code" href="classArServerModeDock.html#a130ef72d4916d9d8e2d0f693ee045dfe" title="Adds the docking information to the given config.">addToConfig</a>(Aria::getConfig());</div>
<div class="line">    modeDock-&gt;<a name="a24"></a><a class="code" href="classArServerModeDock.html#ab290d9d35222c23cb431b28003598a50" title="Adds simple commands to.">addControlCommands</a>(&amp;commands);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Command that resets localization (for debugging but also sometimes useful</span></div>
<div class="line">  <span class="comment">// with MOGS).  See the reinitializeLocalization() above. This is the same as </span></div>
<div class="line">  <span class="comment">// using &quot;Localize to Point&quot; from MobileEyes at the exact localized pose of</span></div>
<div class="line">  <span class="comment">// the robot.</span></div>
<div class="line">  commands.addCommand(<span class="stringliteral">&quot;ReinitLocalization&quot;</span>, <span class="stringliteral">&quot;Re-init localization task at current robot position&quot;</span>, <span class="keyword">new</span> ArGlobalFunctor2&lt;ArRobot*, ArServerHandlerLocalization*&gt;(&amp;reinitializeLocalization, &amp;robot, &amp;serverLocHandler));</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Make Stop mode the default (If current mode deactivates without entering</span></div>
<div class="line">  <span class="comment">// a new mode, then Stop Mode will be selected)</span></div>
<div class="line">  modeStop.addAsDefaultMode();</div>
<div class="line">    <span class="comment">// TODO move up near where stop mode is created?</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/* Services that allow the client to initiate scanning with the laser to</span></div>
<div class="line"><span class="comment">     create maps in Mapper3 (So not possible with SONARNL): */</span></div>
<div class="line"></div>
<div class="line">  ArServerHandlerMapping handlerMapping(&amp;server, &amp;robot, firstLaser, </div>
<div class="line">                    fileDir, <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">true</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// make laser localization stop while mapping</span></div>
<div class="line">  handlerMapping.addMappingStartCallback(</div>
<div class="line">      <span class="keyword">new</span> ArFunctor1C&lt;ArLocalizationTask, bool&gt;</div>
<div class="line">      (&amp;locTask, &amp;<a name="a25"></a><a class="code" href="classArLocalizationTask.html#a8347691797bdba24fa53bb668be7d12e" title="Sets the idle flag.">ArLocalizationTask::setIdleFlag</a>, <span class="keyword">true</span>));</div>
<div class="line"></div>
<div class="line">  <span class="comment">// and then make it start again when we&#39;re doine</span></div>
<div class="line">  handlerMapping.addMappingEndCallback(</div>
<div class="line">      <span class="keyword">new</span> ArFunctor1C&lt;ArLocalizationTask, bool&gt;</div>
<div class="line">      (&amp;locTask, &amp;<a class="code" href="classArLocalizationTask.html#a8347691797bdba24fa53bb668be7d12e" title="Sets the idle flag.">ArLocalizationTask::setIdleFlag</a>, <span class="keyword">false</span>));</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">// Make it so our &quot;lost&quot; actions don&#39;t stop us while mapping</span></div>
<div class="line">  handlerMapping.addMappingStartCallback(actionLostPath.getDisableCB());</div>
<div class="line">  handlerMapping.addMappingStartCallback(actionLostRatioDrive.getDisableCB());</div>
<div class="line">  handlerMapping.addMappingStartCallback(actionLostWander.getDisableCB());</div>
<div class="line"></div>
<div class="line">  <span class="comment">// And then let them make us stop as usual when done mapping</span></div>
<div class="line">  handlerMapping.addMappingEndCallback(actionLostPath.getEnableCB());</div>
<div class="line">  handlerMapping.addMappingEndCallback(actionLostRatioDrive.getEnableCB());</div>
<div class="line">  handlerMapping.addMappingEndCallback(actionLostWander.getEnableCB());</div>
<div class="line"></div>
<div class="line">  <span class="comment">// don&#39;t let forbidden lines show up as obstacles while mapping</span></div>
<div class="line">  <span class="comment">// (they&#39;ll just interfere with driving while mapping, and localization is off anyway)</span></div>
<div class="line">  handlerMapping.addMappingStartCallback(forbidden.getDisableCB());</div>
<div class="line"></div>
<div class="line">  <span class="comment">// let forbidden lines show up as obstacles again as usual after mapping</span></div>
<div class="line">  handlerMapping.addMappingEndCallback(forbidden.getEnableCB());</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">  // If we are on a simulator, move the robot back to its starting position,</span></div>
<div class="line"><span class="comment">  // and reset its odometry.</span></div>
<div class="line"><span class="comment">  // This will allow localizeRobotAtHomeBlocking() below will (probably) work (it</span></div>
<div class="line"><span class="comment">  // tries current odometry (which will be 0,0,0) and all the map</span></div>
<div class="line"><span class="comment">  // home points.</span></div>
<div class="line"><span class="comment">  // (Ignored by a real robot)</span></div>
<div class="line"><span class="comment">  //robot.com(ArCommands::SIM_RESET);</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"></div>
<div class="line">  <span class="comment">// create a pose storage class, this will let the program keep track</span></div>
<div class="line">  <span class="comment">// of where the robot is between runs...  after we try and restore</span></div>
<div class="line">  <span class="comment">// from this file it will start saving the robot&#39;s pose into the</span></div>
<div class="line">  <span class="comment">// file</span></div>
<div class="line">  <a name="_a26"></a><a class="codeRef" doxygen="BaseArnl.tag:../BaseArnl-Reference//" href="../BaseArnl-Reference/classArPoseStorage.html">ArPoseStorage</a> poseStorage(&amp;robot);</div>
<div class="line">  <span class="keywordflow">if</span> (poseStorage.restorePose(<span class="stringliteral">&quot;robotPose&quot;</span>))</div>
<div class="line">    serverLocHandler.setSimPose(robot.getPose());</div>
<div class="line">  <span class="comment">//else</span></div>
<div class="line">  <span class="comment">//   robot.com(ArCommands::SIM_RESET);</span></div>
<div class="line">  <span class="comment">// uncomment the above to reset sim pose to 0,0,0</span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  <span class="comment">/* File transfer services: */</span></div>
<div class="line">  </div>
<div class="line"><span class="preprocessor">#ifdef WIN32</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="comment">// Not implemented for Windows yet.</span></div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Note, file upload/download services are not implemented for Windows; not enabling them.&quot;</span>);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="comment">// This block will allow you to set up where you get and put files</span></div>
<div class="line">  <span class="comment">// to/from, just comment them out if you don&#39;t want this to happen</span></div>
<div class="line">  <span class="comment">// /*</span></div>
<div class="line">  ArServerFileLister fileLister(&amp;server, fileDir);</div>
<div class="line">  ArServerFileToClient fileToClient(&amp;server, fileDir);</div>
<div class="line">  ArServerFileFromClient fileFromClient(&amp;server, fileDir, <span class="stringliteral">&quot;/tmp&quot;</span>);</div>
<div class="line">  ArServerDeleteFileOnServer deleteFileOnServer(&amp;server, fileDir);</div>
<div class="line">  <span class="comment">// */</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="comment">/* Load configuration values, map, and begin! */</span></div>
<div class="line"></div>
<div class="line">  </div>
<div class="line">  <span class="comment">// When parsing the configuration file, also look at the program&#39;s command line options </span></div>
<div class="line">  <span class="comment">// from the command-line argument parser as well as the configuration file.</span></div>
<div class="line">  <span class="comment">// (So you can use any argument on the command line, namely -map.) </span></div>
<div class="line">  Aria::getConfig()-&gt;useArgumentParser(&amp;parser);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Read in parameter files.</span></div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Loading config file %s%s into ArConfig...&quot;</span>, Aria::getDirectory(), Arnl::getTypicalParamFileName());</div>
<div class="line">  <span class="keywordflow">if</span> (!Aria::getConfig()-&gt;parseFile(Arnl::getTypicalParamFileName()))</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;Could not load ARNL configuration file. Set ARNL environment variable to use non-default installation director.y&quot;</span>);</div>
<div class="line">    Aria::exit(5);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Warn about unknown params.</span></div>
<div class="line">  <span class="keywordflow">if</span> (!simpleOpener.checkAndLog() || !parser.checkHelpAndWarnUnparsed())</div>
<div class="line">  {</div>
<div class="line">    logOptions(argv[0]);</div>
<div class="line">    Aria::exit(6);</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Warn if there is no map</span></div>
<div class="line">  <span class="keywordflow">if</span> (map.getFileName() == NULL || strlen(map.getFileName()) &lt;= 0)</div>
<div class="line">  {</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;### No map file is set up, you can make a map with the following procedure&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   0) You can find this information in README.txt or docs/Mapping.txt&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   1) Connect to this server with MobileEyes&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   2) Go to Tools-&gt;Map Creation-&gt;Start Scan&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   3) Give the map a name and hit okay&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   4) Drive the robot around your space (see docs/Mapping.txt&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   5) Go to Tools-&gt;Map Creation-&gt;Stop Scan&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   6) Start up Mapper3&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   7) Go to File-&gt;Open on Robot&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   8) Select the .2d you created&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;   9) Create a .map&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  10) Go to File-&gt;Save on Robot&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  11) In MobileEyes, go to Tools-&gt;Robot Config&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  12) Choose the Files section&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  13) Enter the path and name of your new .map file for the value of the Map parameter.&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;  14) Press OK and your new map should become the map used&quot;</span>);</div>
<div class="line">    ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;&quot;</span>);    </div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Print a log message notifying user of the directory for map files</span></div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Normal, </div>
<div class="line">         <span class="stringliteral">&quot;Directory for maps and file serving: %s&quot;</span>, fileDir);</div>
<div class="line">  </div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;See the ARNL README.txt for more information&quot;</span>);</div>
<div class="line">  ArLog::log(ArLog::Normal, <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Do an initial localization of the robot. ARNL and SONARNL try all the home points</span></div>
<div class="line">  <span class="comment">// in the map, as well as the robot&#39;s current odometric position, as possible</span></div>
<div class="line">  <span class="comment">// places the robot is likely to be at startup.   If successful, it will</span></div>
<div class="line">  <span class="comment">// also save the position it found to be the best localized position as the</span></div>
<div class="line">  <span class="comment">// &quot;Home&quot; position, which can be obtained from the localization task (and is</span></div>
<div class="line">  <span class="comment">// used by the &quot;Go to home&quot; network request).</span></div>
<div class="line">  <span class="comment">// MOGS instead just initializes at the current GPS position.</span></div>
<div class="line">  <span class="comment">// (You will stil have to drive the robot so it can determine the robot&#39;s</span></div>
<div class="line">  <span class="comment">// heading, however. See GPS Mapping instructions.)</span></div>
<div class="line">  locTask.localizeRobotAtHomeBlocking();</div>
<div class="line">  </div>
<div class="line"></div>
<div class="line">  <span class="comment">// Start the networking server&#39;s thread</span></div>
<div class="line">  server.runAsync();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">  ArServerAdvertiser adv(&amp;server, <span class="stringliteral">&quot;arnlServer&quot;</span>, <span class="stringliteral">&quot;Example Server&quot;</span>, <span class="stringliteral">&quot;arnl&quot;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// Enable the motors and wait until the robot exits (disconnection, etc.) or this program is</span></div>
<div class="line">  <span class="comment">// canceled.</span></div>
<div class="line">  robot.enableMotors();</div>
<div class="line">  robot.waitForRunExit();</div>
<div class="line">  Aria::exit(0);</div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Nov 15 2017 13:35:45 for ARNL by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1 </li>
  </ul>
</div>
</body>
</html>
